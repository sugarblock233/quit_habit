<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹ æƒ¯æˆ’é™¤ - ä¸»é¡µ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¯ ä¹ æƒ¯æˆ’é™¤</h1>
            <p class="subtitle">è®°å½•ä½ çš„æ¯ä¸€æ¬¡è¿›æ­¥</p>
        </header>

        <div class="create-habit-section">
            <button class="btn btn-primary" onclick="showCreateModal()">+ åˆ›å»ºæ–°ä¹ æƒ¯</button>
        </div>

        <div id="habits-list" class="habits-list">
            <!-- ä¹ æƒ¯åˆ—è¡¨å°†é€šè¿‡ JavaScript åŠ¨æ€åŠ è½½ -->
        </div>

        <div id="empty-state" class="empty-state" style="display: none;">
            <p>ğŸ“ è¿˜æ²¡æœ‰ä»»ä½•ä¹ æƒ¯</p>
            <p class="hint">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªæˆ’é™¤ç›®æ ‡</p>
        </div>
    </div>

    <!-- åˆ›å»ºä¹ æƒ¯æ¨¡æ€æ¡† -->
    <div id="create-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>åˆ›å»ºæ–°ä¹ æƒ¯</h2>
                <span class="close" onclick="hideCreateModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="create-habit-form">
                    <div class="form-group">
                        <label for="habit-name">ä¹ æƒ¯åç§° *</label>
                        <input type="text" id="habit-name" placeholder="ä¾‹å¦‚ï¼šæˆ’çƒŸã€æˆ’é…’ã€æˆ’ç³–" required>
                    </div>
                    <div class="form-group">
                        <label for="habit-description">æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                        <textarea id="habit-description" rows="3" placeholder="ä¸ºä»€ä¹ˆè¦æˆ’é™¤è¿™ä¸ªä¹ æƒ¯ï¼Ÿ"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="habit-start-date">å¼€å§‹æ—¥æœŸ</label>
                        <input type="date" id="habit-start-date" value="">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="hideCreateModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">åˆ›å»º</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
        document.getElementById('habit-start-date').valueAsDate = new Date();

        // åŠ è½½ä¹ æƒ¯åˆ—è¡¨
        async function loadHabits() {
            try {
                const response = await fetch('/api/habits');
                const habits = await response.json();
                
                const habitsList = document.getElementById('habits-list');
                const emptyState = document.getElementById('empty-state');
                
                if (habits.length === 0) {
                    habitsList.style.display = 'none';
                    emptyState.style.display = 'block';
                    return;
                }
                
                habitsList.style.display = 'block';
                emptyState.style.display = 'none';
                
                habitsList.innerHTML = habits.map(habit => `
                    <div class="habit-card" onclick="location.href='/habit/${habit.id}'">
                        <div class="habit-header">
                            <h3>${habit.name}</h3>
                            <button class="btn-delete" onclick="event.stopPropagation(); deleteHabit(${habit.id})" title="åˆ é™¤">ğŸ—‘ï¸</button>
                        </div>
                        ${habit.description ? `<p class="habit-description">${habit.description}</p>` : ''}
                        <div class="habit-stats">
                            <div class="stat">
                                <span class="stat-label">è¿ç»­æˆåŠŸ</span>
                                <span class="stat-value">${habit.consecutive_days} å¤©</span>
                            </div>
                            ${habit.last_fail_date ? `
                                <div class="stat">
                                    <span class="stat-label">æœ€è¿‘å¤±è´¥</span>
                                    <span class="stat-value">${habit.last_fail_date}</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="habit-info">
                            <small>å¼€å§‹äº ${habit.start_date}</small>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½ä¹ æƒ¯å¤±è´¥:', error);
                alert('åŠ è½½ä¹ æƒ¯åˆ—è¡¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // æ˜¾ç¤ºåˆ›å»ºæ¨¡æ€æ¡†
        function showCreateModal() {
            document.getElementById('create-modal').style.display = 'block';
        }

        // éšè—åˆ›å»ºæ¨¡æ€æ¡†
        function hideCreateModal() {
            document.getElementById('create-modal').style.display = 'none';
            document.getElementById('create-habit-form').reset();
            document.getElementById('habit-start-date').valueAsDate = new Date();
        }

        // æäº¤åˆ›å»ºè¡¨å•
        document.getElementById('create-habit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('habit-name').value;
            const description = document.getElementById('habit-description').value;
            const startDate = document.getElementById('habit-start-date').value;
            
            try {
                const response = await fetch('/api/habits', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name,
                        description,
                        start_date: startDate
                    })
                });
                
                if (response.ok) {
                    hideCreateModal();
                    loadHabits();
                } else {
                    const error = await response.json();
                    alert(error.error || 'åˆ›å»ºå¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ›å»ºä¹ æƒ¯å¤±è´¥:', error);
                alert('åˆ›å»ºå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        });

        // åˆ é™¤ä¹ æƒ¯
        async function deleteHabit(habitId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¹ æƒ¯å—ï¼Ÿæ‰€æœ‰ç›¸å…³è®°å½•ä¹Ÿä¼šè¢«åˆ é™¤ã€‚')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/habits/${habitId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadHabits();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ é™¤ä¹ æƒ¯å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åŠ è½½ä¹ æƒ¯åˆ—è¡¨
        loadHabits();

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('create-modal');
            if (event.target === modal) {
                hideCreateModal();
            }
        }
    </script>
</body>
</html>
